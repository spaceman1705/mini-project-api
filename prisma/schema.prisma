generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  CUSTOMER
  ORGANIZER
}

enum PointType {
  EARNED
  USED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELED
}

enum TransactionStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELED
}

enum NotificationType {
  TRANSACTION
  SYSTEM
  REWARD
}

model RegisterToken {
  id String @id @default(uuid())
  token String @unique
  createdAt DateTime @default(now())
}

model User {
  id String @id @default(uuid())

  firstname String
  lastname String
  email String @unique
  password String
  role Role @default(CUSTOMER)
  refferalCode String @unique
  refferedByUserId String?
  refferedByUser User? @relation("UserRefferal", fields: [refferedByUserId], references: [id], onDelete: SetNull)
  profilePicture String?
  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refferal User[] @relation("UserRefferal")
  point Point[]
  event Event[]
  coupon Coupon[]
  transaction Transaction[]
  review Review[]
  notification Notification[]

  @@map("users")
}

model Point {
  id String @id @default(uuid())

  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount Int
  pointType PointType
  description String
  expiredAt DateTime?
  transactionId String?
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@map("points")
}

model Coupon {
  id String @id @default(uuid())

  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  code String @unique
  discountAmount Float @default(0)
  isUsed Boolean @default(false)
  expiredAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transaction Transaction[]

  @@map("coupons")  
}

model Event {
  id String @id @default(uuid())

  organizerId String
  organizer User @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  title String
  slug String @unique
  description String
  category String
  location String
  startDate DateTime
  endDate DateTime
  price Float @default(0)
  availableSeats Int
  status EventStatus @default(PUBLISHED)
  bannerImg String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticketType TicketType[]
  voucher Voucher[]
  transaction Transaction[]
  review Review[]

  @@map("events")
}

model TicketType {
  id String @id @default(uuid())

  eventId String
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name String
  description String
  price Float @default(0)
  quota Int
  availableQuota Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactionItem TransactionItem[]

  @@map("ticketTypes")
}

model Voucher {
  id String @id @default(uuid())

  eventId String
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  code String @unique
  discountAmount Float @default(0)
  maxUsage Int?
  usedCount Int @default(0)
  expiredAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transaction Transaction[]

  @@map("vouchers")
}

model Transaction {
  id String @id @default(uuid())

  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId String
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  price Float @default(0)
  subtotalPrice Float @default(0)
  pointsUsed Int @default(0)
  couponId String?
  coupon Coupon? @relation(fields: [couponId], references: [id], onDelete: SetNull)
  voucherId String?
  voucher Voucher? @relation(fields: [voucherId], references: [id], onDelete: SetNull)
  discountAmount Float @default(0)
  totalPrice Float @default(0)
  paymentProof String?
  paymentDeadline DateTime?
  confirmationDeadline DateTime?
  status TransactionStatus @default(WAITING_PAYMENT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  point Point[]
  transactionItem TransactionItem[]
  review Review[]

  @@map("transactions")
}

model TransactionItem {
  id String @id @default(uuid())

  transactionId String
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  ticketTypeId String?
  ticketType TicketType? @relation(fields: [ticketTypeId], references: [id], onDelete: SetNull)
  quantity Int
  price Float @default(0)
  subtotal Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("transactionItems")
}

model Review {
  id String @id @default(uuid())

  userId String?
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  eventId String?
  event Event? @relation(fields: [eventId], references: [id], onDelete: SetNull)
  transactionId String
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)  
  rating Int
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}

model Notification {
  id String @id @default(uuid())

  userId String?
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  title String
  message String
  type NotificationType
  isRead Boolean @default(false)

  createdAt DateTime @default(now())

  @@map("notifications")
}